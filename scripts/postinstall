#!/bin/sh
PATH=/usr/local/bin:$PATH
NPM=npm

$NPM install -g /tmp/fuse-x-studio-mac.tgz || exit 1
ln -sf `$NPM prefix -g`/lib/node_modules/@fuse-x/studio-mac/bin/fuse\ X.app /Applications

# Reset permissions
chown -R root:wheel /Applications/fuse\ X.app
chmod +x /Applications/fuse\ X.app/Contents/SketchImporter/fondu
chmod -R a+rwx /Applications/fuse\ X.app/Contents/Modules

if [ -f "/usr/share/uno/SDKs/.sdkconfig" ]; then
	cp "/usr/share/uno/SDKs/.sdkconfig" "/usr/local/share/uno/SDKs/.sdkconfig"
	rm -f "/usr/share/uno/SDKs/.sdkconfig"	
fi

su "$USER" -c '/Applications/fuse\ X.app/Contents/MacOS/fuse\ X kill-all'

# A workaround for a bug where we managed to set the following folder
# with wrong permissions... :/
APPDATA="$HOME/Library/Application Support/Fusetools"
if [ -d "$APPDATA" ]; then
    chown -R "$USER" "$APPDATA"
fi
